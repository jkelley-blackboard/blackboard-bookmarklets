javascript:(()=>{const fr=document.querySelector('iframe[name="bb-base-admin-iframe"]');const d=fr?.contentDocument||document;if(!d.location.pathname.includes('/webapps/blackboard/execute/managePrivileges')){alert('⚠ Go to the manage privileges page of a system or course role.');return}const ensure=()=>{const u=new URLSearchParams(d.location.search);if(u.get('showAll')==='true')return!0;alert('⚠ Show All is required. Click "Show All" on the page, then re-run this bookmarklet.');return!1};if(!ensure())return;let p=d.getElementById('cmpPanel');if(!p){p=d.createElement('div');p.id='cmpPanel';p.style.cssText='position:fixed;top:20px;left:20px;z-index:2147483647;background:#fffbe6;border:3px solid #111;border-radius:8px;padding:12px 12px 10px;min-width:360px;max-height:72vh;overflow:auto;box-shadow:0 6px 18px rgba(0,0,0,.25);font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;';p.innerHTML='<div style="display:flex;align-items:center;gap:8px;justify-content:space-between;margin-bottom:8px;"><strong>Role Privilege Compare</strong><button id="cmpClose" title="Close" style="border:0;background:#6b7280;color:#fff;border-radius:6px;padding:2px 8px;cursor:pointer">✕</button></div><div id="paginationWarning" style="color:#b45309;margin:0 0 6px 0;"></div><div id="buttonRowPrimary" style="display:flex;flex-wrap:wrap;gap:6px;margin:6px 0"></div><div id="roleDetails" style="margin:6px 0"></div><div id="buttonRowFilters" style="display:none;flex-wrap:wrap;gap:6px;margin:6px 0"></div><div id="summary" style="margin:6px 0;color:#111"></div><div id="extras" style="margin-top:8px"></div>';const st=d.createElement('style');st.textContent='#cmpPanel .cmp-ttl{font-weight:600;margin-bottom:4px}#cmpPanel .cmp-srclines{border:1px solid #e5e7eb;background:#ffffff;padding:6px;border-radius:6px;max-height:180px;overflow:auto;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:12px;line-height:1.4}#cmpPanel .cmp-srcline{white-space:pre-wrap;word-break:break-word}#cmpPanel button.cmp-btn{margin:0;padding:6px 10px;font-size:13px;border-radius:6px;border:1px solid #5b21b6;background:#7c3aed;color:#fff;cursor:pointer;box-shadow:0 1px 2px rgba(0,0,0,.06)}#cmpPanel button.cmp-btn:hover{filter:brightness(1.05)}';d.body.appendChild(p);((e)=>{let dx=0,dy=0,sx=0,sy=0,drag=!1;const dn=t=>{drag=!0;sx=t.clientX;sy=t.clientY;t.preventDefault()},mv=t=>{if(!drag)return;dx=t.clientX-sx;dy=t.clientY-sy;sx=t.clientX;sy=t.clientY;e.style.left=e.offsetLeft+dx+'px';e.style.top=e.offsetTop+dy+'px'},up=()=>drag=!1;e.addEventListener('mousedown',dn);d.addEventListener('mousemove',mv);d.addEventListener('mouseup',up)})(p);d.getElementById('cmpClose').onclick=()=>p.remove();p.style.left=(window.innerWidth-p.offsetWidth)/2+'px'}else{p.querySelector('#paginationWarning').textContent='';p.querySelector('#roleDetails').innerHTML='';p.querySelector('#buttonRowFilters').innerHTML='';p.querySelector('#buttonRowFilters').style.display='none';p.querySelector('#summary').textContent='';p.querySelector('#extras').innerHTML=''}const primary=p.querySelector('#buttonRowPrimary'),filters=p.querySelector('#buttonRowFilters');const addBtn=(container,label,handler,id)=>{const b=d.createElement('button');b.textContent=label;if(id)b.id=id;b.className='cmp-btn';b.onclick=handler;container.appendChild(b)};const frameWin=fr?.contentWindow||window;const esc=s=>String(s).replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));const printSource=(data)=>{const hasSrc=Object.prototype.hasOwnProperty.call(data,'source');const src=hasSrc?data.source:undefined;if(src&&typeof src==='object'){const lines=Object.entries(src).map(([k,v])=>`<div class="cmp-srcline">${esc(k)} = ${esc(typeof v==='object'?JSON.stringify(v):String(v))}</div>`).join('');p.querySelector('#roleDetails').innerHTML=`<div class="cmp-ttl">SOURCE</div><div class="cmp-srclines">${lines||'<em>(empty)</em>'}</div>`}else{p.querySelector('#roleDetails').innerHTML='<div class="cmp-ttl">SOURCE</div><em>(no "source" object found in JSON)</em>'}};const tri=()=>{const s=d.createElement('span');s.innerHTML='⚠';s.style.cssText='font-size:20px;color:#f1c40f;margin-left:6px;vertical-align:middle;';return s};const getName=tr=>(tr.querySelector('th div')?.innerText||'').trim();const getActual=tr=>{const img=tr.querySelector('td:nth-child(2) img');const alt=(img?.alt||'').toLowerCase();const src=(img?.getAttribute('src')||'').toLowerCase();if(alt.includes('permit')||src.includes('check'))return'permitted';if(alt.includes('inherit')||src.includes('dash'))return'inherited';return'restricted'};const doCompare=(data)=>{const rows=[...d.querySelectorAll('tbody#listContainer_databody>tr')];const pageNames=new Set;let mism=0,expPerm=0,expRest=0;rows.forEach(tr=>{const name=getName(tr);if(!name)return;pageNames.add(name);const td2=tr.querySelector('td:nth-child(2)');const aRaw=getActual(tr);const aCmp=aRaw==='inherited'?'permitted':aRaw;const exp=data.privileges?.[name]?.status;const old=td2?.querySelector('.cmpWarn');if(old)old.remove();if(exp==='permitted')expPerm++;else if(exp==='restricted')expRest++;if(exp&&exp!==aCmp&&td2){mism++;const m=tri();m.className='cmpWarn';if(exp==='permitted'&&aCmp==='restricted'){m.title='Source is Permitted'}else if(exp==='restricted'&&aCmp==='permitted'){m.title='Source is Restricted'}else{m.title='Mismatch'}td2.appendChild(m)}});const applyFilter=mode=>{rows.forEach(tr=>{const name=getName(tr);const exp=data.privileges?.[name]?.status;const aRaw=getActual(tr);const aCmp=aRaw==='inherited'?'permitted':aRaw;const mm=!!(exp&&exp!==aCmp);const mmPermit=exp==='permitted'&&aCmp==='restricted';const mmRestrict=exp==='restricted'&&aCmp==='permitted';let show=!0;if(mode==='mismatch')show=mm;else if(mode==='permit')show=mmPermit;else if(mode==='restrict')show=mmRestrict;else if(mode==='all')show=!0;tr.style.display=show?'':'none'})};filters.innerHTML='';addBtn(filters,'Mismatch',()=>applyFilter('mismatch'),'filterMismatch');addBtn(filters,'Permit',()=>applyFilter('permit'),'filterPermit');addBtn(filters,'Restrict',()=>applyFilter('restrict'),'filterRestrict');addBtn(filters,'Show All',()=>applyFilter('all'),'filterAll');filters.style.display='flex';p.querySelector('#summary').innerHTML=`Found <b>${mism}</b> mismatches. Expected: <b>${expPerm}</b> permitted, <b>${expRest}</b> restricted.`;const extras=p.querySelector('#extras');const jsonNames=new Set(Object.keys(data.privileges||{}));const onlyJson=[...jsonNames].filter(x=>!pageNames.has(x));const onlyPage=[...pageNames].filter(x=>!jsonNames.has(x));const fmt=a=>a.slice(0,50).map(x=>`<code>${esc(x)}</code>`).join(', ')+(a.length>50?' …':'');extras.innerHTML='';if(onlyJson.length){const dv=d.createElement('div');dv.innerHTML=`<div style="margin-top:6px"><b>In JSON but not on page (${onlyJson.length}):</b> ${fmt(onlyJson)}</div>`;extras.appendChild(dv)}if(onlyPage.length){const dv2=d.createElement('div');dv2.innerHTML=`<div style="margin-top:6px"><b>On page but not in JSON (${onlyPage.length}):</b> ${fmt(onlyPage)}</div>`;extras.appendChild(dv2)}alert('JSON uploaded and mismatches flagged.')};const openUpload=()=>{const inp=d.createElement('input');inp.type='file';inp.accept='.json,application/json';inp.onchange=ev=>{const f=ev.target.files&&ev.target.files[0];if(!f)return;const r=new FileReader;r.onload=e=>{try{const data=JSON.parse(String(e.target.result||'{}'));if(!data||typeof data!=='object')throw new Error('Invalid format');printSource(data);doCompare(data)}catch(err){alert('Invalid JSON file or structure.')}};r.readAsText(f)};inp.click()};if(!primary.dataset._init){primary.innerHTML='';addBtn(primary,'Upload JSON',openUpload,'btnUpload');addBtn(primary,'Refresh Page',()=>frameWin.location.reload(),'btnRefresh');primary.dataset._init='1'}})();
