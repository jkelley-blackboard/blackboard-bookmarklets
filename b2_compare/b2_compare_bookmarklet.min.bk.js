javascript:(async function(){const esc=s=>String(s).replace(/[&<>]/g,c=>({"&":"&","<":"<",">":">"})[c]);const getAdminFrameDocument=()=>{const f=document.querySelector('iframe[name="bb-base-admin-iframe"]');return{frame:f,doc:f?.contentDocument??null}};const isCorrectPage=doc=>doc?.location.pathname.includes("/webapps/plugins/execute/plugInController");const isShowAll=doc=>new URLSearchParams(doc.location.search).get("showAll")==="true";const getPageContext=async doc=>{const host=doc.location.host||"";const timestamp=(new Date).toISOString();const apiUrl=`${doc.location.origin}/learn/api/public/v1/system/version`;let bbVersion;try{const response=await fetch(apiUrl);if(!response.ok)throw new Error(`HTTP ${response.status}`);const data=await response.json();bbVersion=`${data.learn.major}.${data.learn.minor}.${data.learn.patch}-${data.learn.build}`}catch{bbVersion="Unavailable"}return{host:host,bbVersion:bbVersion,timestamp:timestamp}};const parseRow=row=>{const nameInput=row.querySelector("input[name^='name__']");const toolId=nameInput?nameInput.name.split("__")[1]:null;const toolName=nameInput?nameInput.value:row.querySelector("th")?.innerText.trim();const vendor=row.querySelector("td:nth-of-type(2) .table-data-cell-value")?.innerText.trim();const version=row.querySelector("td:nth-of-type(3) .table-data-cell-value")?.innerText.trim();const supportStatus=row.querySelector("td:nth-of-type(4) .table-data-cell-value")?.innerText.trim();const availability=row.querySelector("td:nth-of-type(5) .table-data-cell-value")?.innerText.trim();const showRemoveInactiveAlert=row.querySelector("input[name^='showRemoveInactiveAlert__']")?.value==="true";const hasCheckbox=!!row.querySelector("input[type='checkbox']");return{toolId:toolId,toolName:toolName,vendor:vendor,version:version,supportStatus:supportStatus,availability:availability,showRemoveInactiveAlert:showRemoveInactiveAlert,hasCheckbox:hasCheckbox}};const ensurePanel=doc=>{let panel=doc.getElementById("cmpPanel");if(panel){panel.querySelector("#pageContextTop").innerHTML="";panel.querySelector("#summary").innerHTML="";return panel}panel=doc.createElement("div");panel.id="cmpPanel";panel.style.cssText="position:fixed;top:20px;left:20px;z-index:2147483647;background:#fffbe6;border:3px solid #111;border-radius:8px;padding:12px;min-width:380px;max-height:72vh;overflow:auto;box-shadow:0 6px 18px rgba(0,0,0,.25);font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;";panel.innerHTML='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px"><span style="font-weight:600">B2 Export Utility</span><button id="cmpClose" class="cmp-btn" style="background:#111;color:#fff;padding:2px 8px;border-radius:6px">‚úï</button></div><div id="pageContextTop" style="border:1px solid #e5e7eb;background:#fff;padding:6px;border-radius:6px;margin:6px 0;max-height:120px;overflow:auto;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,\'Liberation Mono\',\'Courier New\',monospace;font-size:12px;line-height:1.35"></div><div id="buttonRowPrimary" style="display:flex;gap:6px;flex-wrap:wrap;margin:6px 0"></div><div id="summary" style="margin-top:6px;font-weight:500"></div>';const style=doc.createElement("style");style.textContent="#cmpPanel .cmp-srcline{white-space:pre-wrap;word-break:break-word;}#cmpPanel button.cmp-btn{margin:0;padding:6px 10px;font-size:13px;border-radius:6px;border:1px solid #5b21b6;background:#7c3aed;color:#fff;cursor:pointer;box-shadow:0 1px 2px rgba(0,0,0,.06);}#cmpPanel button.cmp-btn:hover{filter:brightness(1.05);}";panel.appendChild(style);doc.body.appendChild(panel);panel.querySelector("#cmpClose").onclick=()=>panel.remove();panel.style.left=(doc.defaultView.innerWidth-panel.offsetWidth)/2+"px";return panel};const addBtn=(doc,wrap,label,fn,id)=>{const btn=doc.createElement("button");btn.textContent=label;if(id)btn.id=id;btn.className="cmp-btn";btn.onclick=fn;wrap.appendChild(btn)};const renderPageContext=(doc,panel,ctx)=>{const box=panel.querySelector("#pageContextTop");box.innerHTML='<div style="font-weight:600;margin-bottom:4px">SOURCE CONTEXT</div>'+Object.entries(ctx).map(([k,v])=>`<div class="cmp-srcline">${esc(k)} = ${esc(v)}</div>`).join("")};const{doc}=getAdminFrameDocument();if(!doc)return alert("‚ö† Admin iframe not found. Go to Admin > Tools > Installed Tools to run this.");if(!isCorrectPage(doc))return alert("‚ö† This bookmarklet must be run on the Installed Tools page.");if(!isShowAll(doc))return alert('‚ö† Show All is required. Click "Show All" then re-run.');const panel=ensurePanel(doc);const ctx=await getPageContext(doc);renderPageContext(doc,panel,ctx);const btnRow=panel.querySelector("#buttonRowPrimary");const summary=panel.querySelector("#summary");addBtn(doc,btnRow,"Extract JSON",async()=>{const rows=Array.from(doc.querySelectorAll("tr[id^='unfilteredList_row']"));const tools=rows.map(parseRow).filter(t=>t.toolId);const output={source:ctx,tools:tools};summary.textContent=`‚úÖ Exported ${tools.length} tools.`;const blob=new Blob([JSON.stringify(output,null,2)],{type:"application/json"});const url=URL.createObjectURL(blob);const hostPart=ctx.host.split(".")[0]??"host";const versionPart=ctx.bbVersion.split("-")[0].split(".").slice(0,2).join(".")??"version";const datePart=ctx.timestamp.slice(0,10).replace(/-/g,"");const filename=`blackboard_b2_export_${hostPart}_${versionPart}_${datePart}.json`;const link=doc.createElement("a");link.href=url;link.download=filename;link.click()},"extractBtn");addBtn(doc,btnRow,"Upload & Compare",()=>{const fileInput=doc.createElement("input");fileInput.type="file";fileInput.accept=".json";fileInput.style.display="none";fileInput.onchange=async()=>{const file=fileInput.files[0];if(!file)return;try{const text=await file.text();const uploadedData=JSON.parse(text);const srcInfo=uploadedData.source||{};const uploadedTools=uploadedData.tools??[];summary.innerHTML='<div style="font-weight:600;margin-top:8px">UPLOADED FILE</div><div class="cmp-srcline">File: '+esc(file.name)+'</div><div class="cmp-srcline">Tools: '+uploadedTools.length+'</div><div class="cmp-srcline">System: '+esc(srcInfo.bbVersion??"Unknown")+"</div>";const currentRows=Array.from(doc.querySelectorAll("tr[id^='unfilteredList_row']"));const currentTools=currentRows.map(parseRow).filter(t=>t.toolName&&t.vendor);const mismatches=[];const matches=[];const missing=[];const extra=[];uploadedTools.forEach(uploaded=>{const match=currentTools.find(current=>current.toolName===uploaded.toolName&&current.vendor===uploaded.vendor);if(!match){missing.push({toolName:uploaded.toolName,vendor:uploaded.vendor});return}const diffs=[];if(uploaded.version!==match.version&&match.version!==ctx.bbVersion&&uploaded.version!==ctx.bbVersion)diffs.push(`version: ${uploaded.version} ‚Üí ${match.version}`);if(uploaded.supportStatus!==match.supportStatus)diffs.push(`supportStatus: ${uploaded.supportStatus} ‚Üí ${match.supportStatus}`);if(uploaded.availability!==match.availability)diffs.push(`availability: ${uploaded.availability} ‚Üí ${match.availability}`);if(diffs.length)mismatches.push({toolName:uploaded.toolName,vendor:uploaded.vendor,diffs:diffs});else matches.push(uploaded.toolName)});currentTools.forEach(current=>{const match=uploadedTools.find(u=>u.toolName===current.toolName&&u.vendor===current.vendor);if(!match)extra.push({toolName:current.toolName,vendor:current.vendor})});summary.innerHTML+=`<div style="margin-top:8px">‚úÖ Compared ${uploadedTools.length} tools.</div><div>üîç ${matches.length} matched, ‚ö†Ô∏è ${mismatches.length} mismatched, ‚ùå ${missing.length} missing, ‚ûï ${extra.length} extra.</div>${missing.length?`<div style="margin-top:6px"><strong>Missing (in current):</strong><br>${missing.map(m=>`‚ùå ${esc(m.toolName)} (${esc(m.vendor)})`).join("<br>")}</div>`:""}${extra.length?`<div style="margin-top:6px"><strong>Extra (not in file):</strong><br>${extra.map(m=>`‚ûï ${esc(m.toolName)} (${esc(m.vendor)})`).join("<br>")}</div>`:""}${mismatches.map(m=>`<div style="margin-top:6px"><strong>${esc(m.toolName)}</strong> (${esc(m.vendor)}):<br>${m.diffs.map(d=>`‚ö†Ô∏è ${esc(d)}`).join("<br>")}</div>`).join("")}`;if(mismatches.length||missing.length||extra.length){const exportDiv=doc.createElement("div");exportDiv.style.marginTop="8px";const allIssues=[...mismatches,...missing.map(m=>({...m,diffs:["Missing from current system"]})),...extra.map(m=>({...m,diffs:["Extra in current system"]}))];const plainText=allIssues.map(m=>`${m.toolName} (${m.vendor}):\n${(m.diffs||[]).map(d=>`  - ${d}`).join("\n")}`).join("\n\n");const copyBtn=doc.createElement("button");copyBtn.textContent="üìã Copy Mismatches";copyBtn.className="cmp-btn";copyBtn.onclick=async()=>{await navigator.clipboard.writeText(plainText);copyBtn.textContent="‚úÖ Copied!";setTimeout(()=>copyBtn.textContent="üìã Copy Mismatches",2e3)};const downloadBtn=doc.createElement("button");downloadBtn.textContent="üíæ Download Mismatches";downloadBtn.className="cmp-btn";downloadBtn.onclick=()=>{const blob=new Blob([JSON.stringify(allIssues,null,2)],{type:"application/json"});const url=URL.createObjectURL(blob);const link=doc.createElement("a");link.href=url;link.download=`b2_mismatch_report_${ctx.host.split(".")[0]}_${ctx.timestamp.slice(0,10).replace(/-/g,"")}.json`;link.click()};exportDiv.appendChild(copyBtn);exportDiv.appendChild(downloadBtn);summary.appendChild(exportDiv)}}catch(err){summary.textContent=`‚ùå Failed to parse uploaded file: ${err.message}`}};doc.body.appendChild(fileInput);fileInput.click()},"uploadBtn")})();